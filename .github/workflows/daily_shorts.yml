name: Daily Shorts Script Generator

# ì‹¤í–‰ ì¡°ê±´ ì„¤ì •
on:
  schedule:
    # ë§¤ì¼ ë¯¸êµ­ ë™ë¶€ ì‹œê°„ ì˜¤ì „ 7ì‹œ ì‹¤í–‰ (UTC 12:00)
    # * * * * * í˜•ì‹: ë¶„ ì‹œ ì¼ ì›” ìš”ì¼ (UTC)
    - cron: '0 12 * * *'
    
  workflow_dispatch: # Actions íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ ëˆŒëŸ¬ì„œ ì‹¤í–‰ ê°€ëŠ¥

# [ì¤‘ìš”] ë´‡ì´ ë¦¬í¬ì§€í† ë¦¬ì— íŒŒì¼ì„ ì“°ê³  ì»¤ë°‹í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write

jobs:
  generate-and-save:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # 10ë¶„ ì´ìƒ ê±¸ë¦¬ë©´ ê°•ì œ ì¢…ë£Œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)

    steps:
    # 1. ë‚´ ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜´
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        # [Fix] ImageMagick Policy Error for TextClip (security policy blocks @ path)
        # sed command to allow read/write permissions in policy.xml
        if [ -f /etc/ImageMagick-6/policy.xml ]; then
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml
        fi
        python -m pip install --upgrade pip
        pip install feedparser google-generativeai google-genai
        pip install moviepy edge-tts requests google-auth google-auth-oauthlib google-api-python-client

    # 4. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ëŒ€ë³¸ ìƒì„±)
    - name: Run Shorts Script Generator
      env:
        # GitHub Secretsì— ë“±ë¡í•œ Gemini API í‚¤ ì£¼ì…
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
        YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
        YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
      # ì‹¤í–‰í•  íŒŒì´ì¬ íŒŒì¼ëª…ì´ ì •í™•í•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: daily_shorts.py)
      run: python daily_shorts.py

    # 5. ìƒì„±ëœ ëŒ€ë³¸ íŒŒì¼ì„ ë¦¬í¬ì§€í† ë¦¬ì— ì €ì¥ (Commit & Push)
    - name: Commit and Push Script
      run: |
        # ë´‡ ê³„ì • ì •ë³´ ì„¤ì •
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # scripts í´ë”ì— ìƒˆë¡œ ìƒê¸´ íŒŒì¼ë“¤ì„ ìŠ¤í…Œì´ì§• ì˜ì—­ì— ì¶”ê°€
        git add scripts/
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„± (ë‚ ì§œ í¬í•¨ - ë¯¸êµ­ ì‹œê°„ ê¸°ì¤€)
        # || echo ... ë¶€ë¶„ì€ ë³€ê²½ ì‚¬í•­ì´ ì—†ì„ ë•Œ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•Šë„ë¡ ë°©ì–´í•˜ëŠ” ì½”ë“œ
        git commit -m "ğŸ¤– Daily Shorts Script Generated [$(TZ=America/New_York date +'%Y-%m-%d')]" || echo "No changes to commit"
        
        # ì›ê²© ì €ì¥ì†Œë¡œ í‘¸ì‹œ
        git push

    # 6. ìƒì„±ëœ ë¹„ë””ì˜¤ ë° ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
    - name: Upload Debug Artifacts
      if: always() # ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ê°€ ë‚˜ë„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
      uses: actions/upload-artifact@v4
      with:
        name: generated-shorts-and-logs
        path: |
          final_generated_shorts.mp4
          scripts/
          temp_assets/